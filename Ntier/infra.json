{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.39.26.7824",
      "templateHash": "4731234791865271562"
    }
  },
  "parameters": {
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Azure region for all regional resources"
      }
    },
    "webAppName": {
      "type": "string",
      "defaultValue": "[format('myntierwebapp{0}', uniqueString(resourceGroup().id))]",
      "metadata": {
        "description": "Name of the Web App (must be globally unique)."
      }
    },
    "appServicePlanName": {
      "type": "string",
      "defaultValue": "[format('{0}-plan', parameters('webAppName'))]",
      "metadata": {
        "description": "Name of the App Service Plan."
      }
    },
    "sqlServerName": {
      "type": "string",
      "defaultValue": "[format('myntiersqlserver{0}', uniqueString(resourceGroup().id))]",
      "metadata": {
        "description": "SQL Server name (must be globally unique)."
      }
    },
    "sqlDatabaseName": {
      "type": "string",
      "defaultValue": "[format('{0}-db', parameters('sqlServerName'))]",
      "metadata": {
        "description": "SQL Database name."
      }
    },
    "sqlAdminLogin": {
      "type": "string",
      "defaultValue": "sqladminuser",
      "metadata": {
        "description": "SQL admin username."
      }
    },
    "sqlAdminPassword": {
      "type": "securestring",
      "defaultValue": "P@ssw0rd!23",
      "metadata": {
        "description": "SQL admin password."
      }
    },
    "keyVaultName": {
      "type": "string",
      "defaultValue": "[format('{0}-kv', parameters('webAppName'))]",
      "metadata": {
        "description": "Key Vault name (must be globally unique)."
      }
    },
    "sqlConnectionSecretName": {
      "type": "string",
      "defaultValue": "SqlConnectionString",
      "metadata": {
        "description": "Key Vault secret name to store the SQL connection string."
      }
    },
    "afdProfileName": {
      "type": "string",
      "defaultValue": "[format('{0}-afd', parameters('webAppName'))]",
      "metadata": {
        "description": "Azure Front Door profile name."
      }
    },
    "afdEndpointName": {
      "type": "string",
      "defaultValue": "[format('{0}-endpoint', parameters('webAppName'))]",
      "metadata": {
        "description": "Azure Front Door endpoint name (must be globally unique within Azure Front Door)."
      }
    }
  },
  "variables": {
    "appServiceSkuName": "B1",
    "appServiceSkuTier": "Basic",
    "sqlSkuName": "Basic",
    "keyVaultSkuName": "standard",
    "afdSkuName": "Standard_AzureFrontDoor",
    "keyVaultSecretsUserRoleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '4633458b-17de-408a-b874-0445c86b69e6')]",
    "sqlConnectionString": "[format('Server=tcp:{0}.database.windows.net,1433;Initial Catalog={1};Persist Security Info=False;User ID={2};Password={3};MultipleActiveResultSets=False;Encrypt=True;TrustServerCertificate=False;Connection Timeout=30;', parameters('sqlServerName'), parameters('sqlDatabaseName'), parameters('sqlAdminLogin'), parameters('sqlAdminPassword'))]"
  },
  "resources": [
    {
      "type": "Microsoft.Web/serverfarms",
      "apiVersion": "2023-12-01",
      "name": "[parameters('appServicePlanName')]",
      "location": "[parameters('location')]",
      "sku": {
        "name": "[variables('appServiceSkuName')]",
        "tier": "[variables('appServiceSkuTier')]",
        "capacity": 1
      },
      "properties": {
        "reserved": false
      }
    },
    {
      "type": "Microsoft.Web/sites",
      "apiVersion": "2023-12-01",
      "name": "[parameters('webAppName')]",
      "location": "[parameters('location')]",
      "identity": {
        "type": "SystemAssigned"
      },
      "properties": {
        "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', parameters('appServicePlanName'))]",
        "httpsOnly": true,
        "siteConfig": {
          "ftpsState": "Disabled",
          "minTlsVersion": "1.2",
          "appSettings": [
            {
              "name": "SqlConnectionString",
              "value": "[format('@Microsoft.KeyVault(SecretUri={0})', reference(resourceId('Microsoft.KeyVault/vaults/secrets', parameters('keyVaultName'), parameters('sqlConnectionSecretName')), '2023-07-01').secretUriWithVersion)]"
            }
          ]
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Web/serverfarms', parameters('appServicePlanName'))]",
        "[resourceId('Microsoft.KeyVault/vaults/secrets', parameters('keyVaultName'), parameters('sqlConnectionSecretName'))]"
      ]
    },
    {
      "type": "Microsoft.Sql/servers",
      "apiVersion": "2023-08-01-preview",
      "name": "[parameters('sqlServerName')]",
      "location": "[parameters('location')]",
      "properties": {
        "administratorLogin": "[parameters('sqlAdminLogin')]",
        "administratorLoginPassword": "[parameters('sqlAdminPassword')]",
        "version": "12.0",
        "minimalTlsVersion": "1.2",
        "publicNetworkAccess": "Enabled"
      }
    },
    {
      "type": "Microsoft.Sql/servers/databases",
      "apiVersion": "2023-08-01-preview",
      "name": "[format('{0}/{1}', parameters('sqlServerName'), parameters('sqlDatabaseName'))]",
      "location": "[parameters('location')]",
      "sku": {
        "name": "[variables('sqlSkuName')]"
      },
      "properties": {
        "maxSizeBytes": 2147483648,
        "collation": "SQL_Latin1_General_CP1_CI_AS"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Sql/servers', parameters('sqlServerName'))]"
      ]
    },
    {
      "type": "Microsoft.Sql/servers/firewallRules",
      "apiVersion": "2023-08-01-preview",
      "name": "[format('{0}/{1}', parameters('sqlServerName'), 'AllowAzureServices')]",
      "properties": {
        "startIpAddress": "0.0.0.0",
        "endIpAddress": "0.0.0.0"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Sql/servers', parameters('sqlServerName'))]"
      ]
    },
    {
      "type": "Microsoft.KeyVault/vaults",
      "apiVersion": "2023-07-01",
      "name": "[parameters('keyVaultName')]",
      "location": "[parameters('location')]",
      "properties": {
        "tenantId": "[subscription().tenantId]",
        "sku": {
          "name": "[variables('keyVaultSkuName')]",
          "family": "A"
        },
        "enableRbacAuthorization": true
      }
    },
    {
      "type": "Microsoft.KeyVault/vaults/secrets",
      "apiVersion": "2023-07-01",
      "name": "[format('{0}/{1}', parameters('keyVaultName'), parameters('sqlConnectionSecretName'))]",
      "properties": {
        "value": "[variables('sqlConnectionString')]"
      },
      "dependsOn": [
        "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]"
      ]
    },
    {
      "type": "Microsoft.Authorization/roleAssignments",
      "apiVersion": "2022-04-01",
      "scope": "[format('Microsoft.KeyVault/vaults/{0}', parameters('keyVaultName'))]",
      "name": "[guid(resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName')), resourceId('Microsoft.Web/sites', parameters('webAppName')), variables('keyVaultSecretsUserRoleDefinitionId'))]",
      "properties": {
        "roleDefinitionId": "[variables('keyVaultSecretsUserRoleDefinitionId')]",
        "principalId": "[reference(resourceId('Microsoft.Web/sites', parameters('webAppName')), '2023-12-01', 'full').identity.principalId]",
        "principalType": "ServicePrincipal"
      },
      "dependsOn": [
        "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]",
        "[resourceId('Microsoft.Web/sites', parameters('webAppName'))]"
      ]
    },
    {
      "type": "Microsoft.Cdn/profiles",
      "apiVersion": "2024-05-01",
      "name": "[parameters('afdProfileName')]",
      "location": "global",
      "sku": {
        "name": "[variables('afdSkuName')]"
      }
    },
    {
      "type": "Microsoft.Cdn/profiles/afdEndpoints",
      "apiVersion": "2024-05-01",
      "name": "[format('{0}/{1}', parameters('afdProfileName'), parameters('afdEndpointName'))]",
      "location": "global",
      "properties": {
        "enabledState": "Enabled"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Cdn/profiles', parameters('afdProfileName'))]"
      ]
    },
    {
      "type": "Microsoft.Cdn/profiles/originGroups",
      "apiVersion": "2024-05-01",
      "name": "[format('{0}/{1}', parameters('afdProfileName'), format('{0}-og', parameters('webAppName')))]",
      "properties": {
        "loadBalancingSettings": {
          "sampleSize": 4,
          "successfulSamplesRequired": 3,
          "additionalLatencyInMilliseconds": 0
        },
        "healthProbeSettings": {
          "probePath": "/",
          "probeRequestType": "GET",
          "probeProtocol": "Https",
          "probeIntervalInSeconds": 120
        },
        "sessionAffinityState": "Disabled"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Cdn/profiles', parameters('afdProfileName'))]"
      ]
    },
    {
      "type": "Microsoft.Cdn/profiles/originGroups/origins",
      "apiVersion": "2024-05-01",
      "name": "[format('{0}/{1}/{2}', parameters('afdProfileName'), format('{0}-og', parameters('webAppName')), format('{0}-origin', parameters('webAppName')))]",
      "properties": {
        "hostName": "[reference(resourceId('Microsoft.Web/sites', parameters('webAppName')), '2023-12-01').defaultHostName]",
        "originHostHeader": "[reference(resourceId('Microsoft.Web/sites', parameters('webAppName')), '2023-12-01').defaultHostName]",
        "httpPort": 80,
        "httpsPort": 443,
        "priority": 1,
        "weight": 1000,
        "enabledState": "Enabled"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Cdn/profiles/originGroups', parameters('afdProfileName'), format('{0}-og', parameters('webAppName')))]",
        "[resourceId('Microsoft.Web/sites', parameters('webAppName'))]"
      ]
    },
    {
      "type": "Microsoft.Cdn/profiles/afdEndpoints/routes",
      "apiVersion": "2024-05-01",
      "name": "[format('{0}/{1}/{2}', parameters('afdProfileName'), parameters('afdEndpointName'), format('{0}-route', parameters('webAppName')))]",
      "properties": {
        "originGroup": {
          "id": "[resourceId('Microsoft.Cdn/profiles/originGroups', parameters('afdProfileName'), format('{0}-og', parameters('webAppName')))]"
        },
        "supportedProtocols": [
          "Http",
          "Https"
        ],
        "patternsToMatch": [
          "/*"
        ],
        "forwardingProtocol": "HttpsOnly",
        "httpsRedirect": "Enabled",
        "linkToDefaultDomain": "Enabled",
        "enabledState": "Enabled"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Cdn/profiles/afdEndpoints', parameters('afdProfileName'), parameters('afdEndpointName'))]",
        "[resourceId('Microsoft.Cdn/profiles/originGroups', parameters('afdProfileName'), format('{0}-og', parameters('webAppName')))]"
      ]
    }
  ],
  "outputs": {
    "webAppUrl": {
      "type": "string",
      "value": "[format('https://{0}', reference(resourceId('Microsoft.Web/sites', parameters('webAppName')), '2023-12-01').defaultHostName)]"
    },
    "webAppManagedIdentityPrincipalId": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Web/sites', parameters('webAppName')), '2023-12-01', 'full').identity.principalId]"
    },
    "sqlServerFqdn": {
      "type": "string",
      "value": "[format('{0}.database.windows.net', parameters('sqlServerName'))]"
    },
    "sqlDbResourceId": {
      "type": "string",
      "value": "[resourceId('Microsoft.Sql/servers/databases', parameters('sqlServerName'), parameters('sqlDatabaseName'))]"
    },
    "keyVaultUri": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName')), '2023-07-01').vaultUri]"
    },
    "sqlConnSecretUriWithVersion": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.KeyVault/vaults/secrets', parameters('keyVaultName'), parameters('sqlConnectionSecretName')), '2023-07-01').secretUriWithVersion]"
    },
    "frontDoorEndpointHost": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Cdn/profiles/afdEndpoints', parameters('afdProfileName'), parameters('afdEndpointName')), '2024-05-01').hostName]"
    },
    "frontDoorUrl": {
      "type": "string",
      "value": "[format('https://{0}', reference(resourceId('Microsoft.Cdn/profiles/afdEndpoints', parameters('afdProfileName'), parameters('afdEndpointName')), '2024-05-01').hostName)]"
    }
  }
}